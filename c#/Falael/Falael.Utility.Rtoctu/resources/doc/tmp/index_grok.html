<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat App</title>
    <script>
        const CHECK_NEW = 'http://localhost:3000/api/check-new?validTimestamp=';
        const ALL_CHATS = 'http://localhost:3000/api/all-chats';
        const READ_CHAT = 'http://localhost:3000/api/read-chat?id=';
        const POST_MSG = 'http://localhost:3000/api/post-message';
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@4.0.0/marked.min.js"></script>
    <style>
        body { margin: 0; padding: 0; }
        #chat-list { position: fixed; left: 0; top: 0; height: 100vh; width: 25%; overflow-y: auto; background: #f5f5f5; padding: 10px; }
        .chat-item { cursor: pointer; padding: 10px; border-bottom: 1px solid #ddd; }
        .chat-item.selected { background: #e0e0e0; }
        .chat-item.new { background: yellow; }
        #chat-container { margin-left: 25%; height: 100vh; position: relative; }
        #chat-content { height: calc(100vh - 100px); overflow-y: auto; padding: 20px; }
        #input-div { position: fixed; bottom: 0; left: 25%; width: 75%; height: 100px; background: #fff; padding: 10px; box-sizing: border-box; }
        #input { width: 100%; height: 100%; resize: none; }
    </style>
    <script>
        let currentChatId = null;
        let validTimestamp = 0;
        let busy = false;
        let chats = [];

        function isAtBottom() {
            const el = $('#chat-content')[0];
            return el.scrollTop + el.clientHeight >= el.scrollHeight - 20;
        }

        function loadChatList(callback = () => {}) {
            $.get(ALL_CHATS, function(data) {
                const oldIds = chats.map(c => c.chatId);
                chats = data.chats;
                $('#chat-list').empty();
                chats.forEach(chat => {
                    const isNew = !oldIds.includes(chat.chatId);
                    const clas = (isNew ? 'new ' : '') + (chat.chatId === currentChatId ? 'selected' : '');
                    $('#chat-list').append(`<div class="chat-item ${clas}" data-id="${chat.chatId}">${chat.title} (${chat.time})</div>`);
                });
                validTimestamp = data.validTimestamp;
                callback();
            }).fail(() => callback());
        }

        function loadChat(id, isSwitch = false) {
            const wasAtBottom = isAtBottom();
            const scrollPos = $('#chat-content').scrollTop();
            $.get(READ_CHAT + id, function(data) {
                $('#chat-content').html(marked.parse(data.content)); // Assumes content is Markdown; role ignored as per spec (likely for last message).
                validTimestamp = data.validTimestamp;
                if (isSwitch || wasAtBottom) {
                    $('#chat-content').scrollTop($('#chat-content')[0].scrollHeight);
                } else {
                    $('#chat-content').scrollTop(scrollPos);
                }
            });
        }

        $(document).ready(function() {
            loadChatList();

            $('#chat-list').on('click', '.chat-item', function() {
                $('.chat-item').removeClass('selected');
                $(this).addClass('selected').removeClass('new');
                currentChatId = $(this).data('id');
                loadChat(currentChatId, true);
            });

            $('#input').on('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    const content = $(this).val().trim();
                    if (content && currentChatId) {
                        $.post(POST_MSG, { chatId: currentChatId, content }, function(data) {
                            validTimestamp = data.validTimestamp;
                            if (data.event === 'changed') {
                                loadChat(currentChatId, false);
                            }
                        });
                        $(this).val('');
                    }
                }
            });

            setInterval(() => {
                if (busy || !currentChatId) return;
                busy = true;
                $.get(CHECK_NEW + validTimestamp, function(res) {
                    if (res === true) {
                        loadChatList(() => {
                            if (chats.some(c => c.chatId === currentChatId)) {
                                loadChat(currentChatId, false);
                            }
                            busy = false;
                        });
                    } else {
                        busy = false;
                    }
                }).fail(() => busy = false);
            }, 1000);
        });
    </script>
</head>
<body>
    <div id="chat-list"></div>
    <div id="chat-container">
        <div id="chat-content"></div>
        <div id="input-div">
            <textarea id="input" class="materialize-textarea"></textarea>
        </div>
    </div>
</body>
</html>